#!/usr/bin/env node

/**
 * Mission Control CLI tool
 * Input: {"action":"tasks.create","payload":{...}}
 * Output: {"ok":true,"data":{...}} or {"ok":false,"error":{...}}
 */

import { ConvexHttpClient } from "convex/browser";
import { api } from "../../convex/convex/_generated/api.js";

function readStdin() {
  return new Promise((resolve) => {
    let data = "";
    process.stdin.setEncoding("utf8");
    process.stdin.on("data", (chunk) => (data += chunk));
    process.stdin.on("end", () => resolve(data));
  });
}

function error(code, message) {
  return { ok: false, error: { code, message } };
}

const raw = await readStdin();
const input = raw ? JSON.parse(raw) : {};

if (!input.action) {
  process.stdout.write(JSON.stringify(error("INVALID_ACTION", "Missing action")));
  process.exit(1);
}

const convexUrl = process.env.MISSION_CONTROL_CONVEX_URL;
const deployKey = process.env.MISSION_CONTROL_CONVEX_DEPLOY_KEY;

if (!convexUrl) {
  process.stdout.write(JSON.stringify(error("MISSING_ENV", "MISSION_CONTROL_CONVEX_URL not set")));
  process.exit(1);
}

const client = new ConvexHttpClient(convexUrl);
if (deployKey) {
  client.setAuth(async () => deployKey);
}

const payload = input.payload || {};

const actions = {
  "agents.upsert": () => client.mutation(api.agents.upsert, payload),
  "agents.setStatus": () => client.mutation(api.agents.setStatus, payload),
  "agents.list": () => client.query(api.agents.list, payload),
  "tasks.create": () => client.mutation(api.tasks.create, payload),
  "tasks.update": () => client.mutation(api.tasks.update, payload),
  "tasks.list": () => client.query(api.tasks.list, payload),
  "tasks.get": () => client.query(api.tasks.get, payload),
  "tasks.byAssignee": () => client.query(api.tasks.byAssignee, payload),
  "messages.create": () => client.mutation(api.messages.create, payload),
  "messages.byTask": () => client.query(api.messages.byTask, payload),
  "documents.create": () => client.mutation(api.documents.create, payload),
  "documents.list": () => client.query(api.documents.list, payload),
  "activities.create": () => client.mutation(api.activities.create, payload),
  "notifications.create": () => client.mutation(api.notifications.create, payload),
  "notifications.undelivered": () => client.query(api.notifications.undelivered, payload),
  "notifications.markDelivered": () => client.mutation(api.notifications.markDelivered, payload),
  "feed.list": () => client.query(api.feed.list, payload),
  "seed.run": () => client.mutation(api.seed.seedData, payload),
  "seed.clear": () => client.mutation(api.seed.clearSeed, payload),
};

if (!actions[input.action]) {
  process.stdout.write(JSON.stringify(error("INVALID_ACTION", `Unknown action: ${input.action}`)));
  process.exit(1);
}

try {
  const data = await actions[input.action]();
  process.stdout.write(JSON.stringify({ ok: true, data }));
} catch (err) {
  process.stdout.write(JSON.stringify(error("REQUEST_FAILED", err?.message || "Request failed")));
  process.exit(1);
}
